# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é Real-time —Ñ—É–Ω–∫—Ü–∏–π –≤ Sobranie

## üìã –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

–î–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ Sobranie —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:

1. **WebSockets** - –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π —Å–≤—è–∑–∏ (—á–∞—Ç, presence)
2. **Server-Sent Events (SSE)** - –¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ª–µ–Ω—Ç–∞)
3. **REST API** - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. WebSocket –º–æ–¥—É–ª—å (`/realtime/ws`)
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª—ã
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π ping/pong

### 2. SSE –º–æ–¥—É–ª—å (`/realtime/events`)
- ‚úÖ –ü–æ—Ç–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–Ω—Ç—ã (–∑–∞–≥–æ—Ç–æ–≤–∫–∞)
- ‚úÖ Heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–ø—Ä–∏–º–µ—Ä)
- ‚úÖ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

```bash
# –ï—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
cd /home/kirill/projects/sobranie_elysia_api
bun add @elysiajs/websocket

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
bun run dev

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket
wscat -c ws://localhost:3000/realtime/ws -H "Authorization: Bearer YOUR_TOKEN"

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSE
curl -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Accept: text/event-stream" \
     http://localhost:3000/realtime/events
```

### –®–∞–≥ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–æ–¥—É–ª—è–º–∏ (1 –Ω–µ–¥–µ–ª—è)

1. **–ú–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
   ```typescript
   // –í src/modules/notifications/index.ts –¥–æ–±–∞–≤–∏—Ç—å:
   import { sendToUser } from '../realtime/websocket';
   import { SSEBroadcaster } from '../realtime/sse';
   
   // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   const notification = await prisma.notifications.create({...});
   
   // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
   sendToUser(userId, {
     type: 'notification',
     data: notification
   });
   
   // –ò —á–µ—Ä–µ–∑ SSE
   await SSEBroadcaster.sendNotification(userId, notification);
   ```

2. **–ú–æ–¥—É–ª—å –ø–æ—Å—Ç–æ–≤**
   ```typescript
   // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞
   const post = await prisma.posts.create({...});
   
   // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
   sendToChannel(`circle:${post.circleId}`, {
     type: 'new_post',
     data: post
   });
   ```

### –®–∞–≥ 3: –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

**React –ø—Ä–∏–º–µ—Ä:**
```tsx
// hooks/useRealtime.ts
import { useEffect, useRef } from 'react';
import { SobranieRealtimeClient } from '../lib/realtime-client';

export function useRealtime(token: string) {
  const clientRef = useRef<SobranieRealtimeClient>();
  
  useEffect(() => {
    const client = new SobranieRealtimeClient({
      apiUrl: process.env.NEXT_PUBLIC_API_URL!,
      wsUrl: process.env.NEXT_PUBLIC_WS_URL!,
      token
    });
    
    client
      .on('onConnect', () => {
        console.log('Real-time connected');
      })
      .on('onNotification', (notification) => {
        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(notification);
      })
      .on('onMessage', (channel, message) => {
        // –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
        updateChat(channel, message);
      });
    
    client.connect();
    clientRef.current = client;
    
    return () => {
      client.disconnect();
    };
  }, [token]);
  
  return clientRef.current;
}
```

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Redis (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
bun add ioredis

# Docker compose –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  redis_data:
```

### –®–∞–≥ 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

1. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ health endpoint**
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π**
3. **Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è production

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- 1 —Å–µ—Ä–≤–µ—Ä Elysia (2-4 CPU, 4-8 GB RAM)
- PostgreSQL (—É–∂–µ –µ—Å—Ç—å)
- Redis (2 GB RAM)
- Nginx –∫–∞–∫ reverse proxy

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- 2-3 —Å–µ—Ä–≤–µ—Ä–∞ Elysia –∑–∞ load balancer
- PostgreSQL —Å —Ä–µ–ø–ª–∏–∫–æ–π
- Redis cluster
- CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

### –° —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π:
- **–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è**: –¥–æ 10,000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö
- **–°–æ–æ–±—â–µ–Ω–∏—è**: –¥–æ 1,000/—Å–µ–∫
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: < 100ms (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–µ–≥–∏–æ–Ω–∞)

### –° Redis –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
- **–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è**: –¥–æ 100,000 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö
- **–°–æ–æ–±—â–µ–Ω–∏—è**: –¥–æ 10,000/—Å–µ–∫
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: < 50ms

## üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Artillery –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
npm install -g artillery

# –°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

```yaml
# artillery-test.yml
config:
  target: "ws://localhost:3000"
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 120
      arrivalRate: 50
      name: "Ramp up"

scenarios:
  - name: "WebSocket chat"
    engine: "ws"
    flow:
      - connect: "/realtime/ws"
      - send: '{"type":"subscribe","channel":"test"}'
      - think: 5
      - send: '{"type":"message","channel":"test","data":{"text":"Hello"}}'
      - think: 10
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production:
- Grafana dashboards
- Alerts –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - Rate limiting (100 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª–∞–º

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (64KB)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**:
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   - –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è offline –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - Graceful shutdown

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Elysia WebSocket –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://elysiajs.com/plugins/websocket)
- [–ü—Ä–∏–º–µ—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤](/docs/realtime-client-example.ts)
- [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è](/docs/realtime-scaling-strategy.md)
- [–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π](/docs/realtime-research.md)

## üí° –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.

---

**–ì–æ—Ç–æ–≤–æ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é!** üöÄ
